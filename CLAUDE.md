# 재무 프로젝트 공통 매뉴얼

## 최우선 원칙: 데이터 완결성

### 절대 원칙
- **데이터 완결성이 모든 다른 고려사항보다 우선**
- 확실하지 않은 데이터는 절대 입력하지 않음
- 추정값, 기본값(0), 근사치 입력 완전 금지
- **의심스러우면 빈 값으로 두고 시각적 표시**

### 데이터 이상 시 처리 방법
- 해당 Excel 셀을 노란색(#FFFF00)으로 마킹
- 값은 비워두거나 원본 그대로 유지
- ./log/YYYY-MM-DD_HHMMSS.log 파일에 상세 기록
- 사용자에게 명확한 이슈 보고

### 핵심 철학
**틀린 데이터보다 빈 데이터가 훨씬 안전하다**

### 작업 보고 검증 의무화 (2025.08.20 추가)
**모든 작업 보고 전 반드시:**
1. **실제 데이터 존재 여부 확인**
2. **로그 파일 내용과 100% 일치 검증**
3. **추정/가정 없이 사실만 보고**
4. **실패는 실패로, 성공은 증거와 함께 보고**

**증거 없는 성공 보고 시 즉시 수정 요구**

#### 보고 전 필수 체크리스트
**모든 작업 완료 보고 전 확인:**
- [ ] 실제 데이터 출력 확인됨
- [ ] 로그 파일에 기록됨  
- [ ] 오류 메시지 없음
- [ ] 추정/가정 없이 작성됨
- [ ] 로그와 보고서 내용 100% 일치

**체크리스트 미완료 시 보고 금지**

## 작업 원칙

### 1. 파일 관리
- 작업 완료시 **반드시 파일 전체 경로**를 명시
- 기존 파일 편집 우선, 새 파일 생성 최소화
- Excel 파일에는 **색상 적용 금지**
- 임시 파일들은 정리 후 삭제

### 2. 재무 데이터 처리
- **VAT 포함/제외 여부 반드시 확인**
- 부가세대급금(13500) 계정과 연계 분석
- 미지급금은 VAT 포함 금액일 가능성 검토
- 재무제표용 데이터는 VAT 제외 금액 사용

### 3. Excel 작업 규칙
- 새 시트 추가 방식으로 분석 확장
- 데이터만 입력, 서식/색상 적용 금지 (단, 노란색 데이터 이슈 마킹은 예외)
- 원장 파일에 분석 시트 직접 추가 권장
- 계산식보다는 확정된 수치 우선
- 수식 적용 전 반드시 샘플 데이터로 검증
- 행/열 참조가 올바른지 확인 (특히 여러 시트 참조 시)
- 수식 복사 후 참조 이동이 정확한지 검증
- 모든 수식 수정 후 결과값 샘플 검증 필수

### 4. 분석 보고서
- 요약-상세 순서로 구성
- 금액은 천원 단위 콤마 표시
- VAT 조정 전후 구분 명시
- 주요 발견사항과 권고사항 포함

### 5. 파일 명명 규칙
- 날짜: YYYY년MM월DD일 또는 YYYY-MM-DD
- 버전: _v1, _v2 형식
- 용도: _분석, _요약, _원장 등 명시
- 한글 파일명 사용 가능

## 재무 용어 정의

### 계정 과목
- **미지급금(25300)**: 재화/용역 제공받았으나 미지급 채무
- **부가세대급금(13500)**: 지급할 부가가치세
- **부가세예수금(25500)**: 수취한 부가가치세

### 분석 용어
- **VAT 포함**: 부가세가 포함된 총액
- **VAT 제외**: 부가세를 제외한 순액 (실제 비용)
- **지급률**: 지급완료 금액 / 총 채무 금액
- **반영률**: 실제 발생 / 계획 금액

## 주의사항

### 데이터 검증
- 원장 잔액과 세부 내역 일치성 확인
- VAT 계산시 10% 세율 적용
- 대형 거래는 VAT 포함 추정, 소액은 별도 관리 추정
- 비과세 거래 (법무, 번역 등) 구분

### 보고서 작성
- 결론을 먼저 제시
- 구체적 금액과 비율 명시
- 후속 조치 방안 제안
- 파일 경로 반드시 포함

### 6. 오류 처리 및 검증 규칙
- 모든 에러 메시지는 반드시 상세 분석 후 보고
- 동일 방식 3회 실패시 다른 접근법 시도 필수
- 결과 검증은 반드시 실제 데이터로 확인
- 작업 완료 보고 전 체크리스트:
  * 에러 메시지 없음 확인
  * 실제 데이터 검증 완료
  * 최소 3개 이상의 샘플 케이스 테스트
  * 다른 시트/셀 참조 정확성 검증

### 7. 업무 프로세스
- Plan Mode 단계:
  * 사용자와 함께 전체 작업 계획 수립
  * 구체적인 단계와 실행 방법 정리
  * ExitPlanMode로 사용자 승인 요청

- 실행 단계:
  * 승인된 계획을 처음부터 끝까지 중단 없이 실행
  * 중간에 추가 확인이나 질문 없음
  * 모든 단계를 연속적으로 수행
  * 작업이 완전히 끝날 때까지 멈추지 않음

### 8. 응답 형식 규칙
1. 모든 응답은 반드시 다음 형식을 따를 것:
```
작업 파일: [전체 경로]

[응답 내용]

작업 완료 파일: [전체 경로]
```

2. 작업 시작 전 반드시 작업 파일 경로 명시
3. 작업 완료 후 반드시 결과 파일 경로 명시
4. 경로 미표시 시 응답 거부
5. **모든 텍스트 파일(.txt, .md) 생성시 UTF-8 인코딩 보장**

### 9. Python 스크립트 활용 규칙
- **스크립트 우선 사용**:
  * **c:\K04_cashflow_1\Script 폴더의 기존 코드만 적극 활용**
  * 새 코드 작성 전 관련 스크립트 존재 여부 확인
  * 유사한 작업의 기존 스크립트 수정/확장 우선
  * **다른 프로젝트 스크립트 사용 금지**

- **절대 금지 사항 (사용자 허락 없이 금지)**:
  * PRD에 맞지 않는 새로운 스크립트 생성 절대 금지
  * 임시 분석용 .py 파일 생성 금지
  * Task 도구를 통한 무분별한 스크립트 생성 금지
  * 사용자 명시적 승인 없는 새 파일 생성 완전 차단

- **스크립트 카테고리별 활용**:
  * data_extraction: 원장 데이터 추출 작업
  * data_integration: 여러 파일 통합 및 재구성
  * formatting: 표시 형식 및 가독성 개선
  * formula_updates: 수식 수정 및 계산 업데이트
  * utilities: 파일 변환, 검증, 백업 등

- **스크립트 실행 전 확인사항**:
  * 파일 경로와 시트명이 스크립트와 일치하는지 확인
  * 백업 파일 생성 여부 확인
  * 실행 전 샘플 데이터로 테스트

### 10. 인코딩 및 환경 설정
- **한글 파일명 처리**:
  * Windows 환경에서는 UTF-8 인코딩 사용 (chcp 65001)
  * PowerShell 사용시 -Encoding UTF8 옵션 추가
  * 한글 파일명은 가능한 영문/숫자로 변환 권장
  
- **텍스트 파일 UTF-8 인코딩 필수**:
  * **모든 .txt, .md 파일은 반드시 UTF-8 인코딩 사용**
  * Python 파일 읽기/쓰기시 `encoding='utf-8'` 명시적 지정
  * 로그 파일 생성시 UTF-8 인코딩 보장
  * 한국어 텍스트 깨짐 방지 최우선
  
- **Python 파일 작성 규칙**:
  * 모든 텍스트 파일 처리시 `open(파일, 'r/w', encoding='utf-8')` 사용
  * logging 모듈 사용시 UTF-8 인코딩 보장
  * pandas 파일 저장시 `encoding='utf-8-sig'` 옵션 사용 (Excel 호환)
  * 한국어 포함 문자열 처리시 인코딩 명시

- **명령어 환경 구분**:
  * Windows CMD: copy, ren, del 명령어
  * PowerShell: Copy-Item, Rename-Item, Remove-Item
  * Bash/Unix: cp, mv, rm 명령어
  * 현재 환경 확인 후 적절한 명령어 사용

- **파일 경로 규칙**:
  * Windows: 백슬래시(\) 사용 또는 슬래시(/) 허용
  * 공백 포함 경로는 반드시 따옴표로 감싸기
  * 절대 경로 사용 권장 (상대 경로 지양)

- **인코딩 오류 대처**:
  * 한글 깨짐 현상 발생시 UTF-8 인코딩 재확인
  * Excel 파일 저장시 xlsx 형식 우선 사용
  * CSV 저장시 UTF-8 with BOM 옵션 사용
  * 로그 파일 한글 깨짐시 인코딩 설정 점검

### 11. Excel 함수 호환성 관리 규칙
- **새로운 Excel 함수 적용 시 검증 절차**:
  * 적용 전 반드시 샘플 테스트 실행
  * 주요 환경에서 함수 지원 여부 확인 (한글 Excel, 다양한 버전)
  * IFS, XLOOKUP 등 신규 함수는 호환성 문제 가능성 고려
  * #NAME? 오류 발생 시 즉시 기존 안정 함수로 복원

- **함수 선택 우선순위**:
  * 1순위: 모든 환경에서 안정적으로 작동하는 기존 함수 (IF, VLOOKUP 등)
  * 2순위: 가독성 개선을 위한 새로운 함수 (단, 충분한 테스트 후)
  * 기능 개선보다 안정성과 호환성을 우선 고려

- **오류 처리 및 복원 방법**:
  * 새 함수 적용 전 반드시 백업 파일 생성
  * #NAME? 또는 기타 함수 오류 발생 시:
    1. 즉시 작업 중단
    2. 백업 파일로 복원
    3. 기존 안정 함수 방식으로 재적용
    4. 문제 상황과 해결 과정 문서화

- **중첩 IF vs IFS 함수 기준**:
  * 조건 3개 이하: 중첩 IF 사용 (안정성 우선)
  * 조건 4개 이상이고 호환성 확인된 환경: IFS 고려
  * 불확실한 환경에서는 항상 중첩 IF 사용

### 12. 프로젝트 상태 관리 규칙
- **PROJECT_STATUS.md 필수 업데이트**:
  * 주요 작업 시작 전: 새 섹션이나 항목 추가
  * 작업 완료 후: 결과 파일 경로와 핵심 내용 즉시 기록
  * 문제 해결 시: 해결 방법과 교훈 기록
  * 중요 발견사항: 향후 참고할 분석 결과 추가

- **업데이트 목적**:
  * Context Range 최적화: 전체 대화 내역 대신 핵심 요약 활용
  * 연속성 보장: 세션 간 끊김 없는 작업 맥락 유지
  * 진행 상황 추적: 완료/진행중/예정 작업 명확한 구분
  * 파일 경로 중앙화: 모든 중요 파일 위치 통합 관리

- **업데이트 형식**:
  * 작업 일자와 프로젝트명 명시
  * 파일 경로는 절대 경로로 기록
  * 완료 작업은 ✅ 체크 표시
  * 주요 발견사항과 수치는 구체적으로 기록

- **Context 효율성 원칙**:
  * 매 작업마다 PROJECT_STATUS.md 우선 확인
  * 상세 기술 내용은 별도 로그 파일 생성
  * 반복 작업은 패턴화하여 재사용 가능하게 기록

### 13. 원장 데이터 추출 및 중간 결과 파일 생성 규칙

- **데이터 완결성 최우선 원칙 적용**:
  * 확실하지 않은 데이터는 절대 추정하지 않음
  * 전기이월은 B5 텍스트가 "전기이월"일 때만 처리, 아니면 빈값
  * 계정 분류 실패시 노란색 마킹하고 처리 제외
  * 모든 이상 상황은 ./log/날짜-시간.log에 기록

- **계정 성격별 이원화 처리 원칙**:
  * **BS 계정 (잔액 중심)**: 월말 최종 잔액 추출
    - 자산계정: 예금, 재고, 고정자산 등 (100-200번대)
    - 부채계정: 미지급금, 차입금, 충당부채 등 (250-290번대)  
    - 자본계정: 자본금, 결손금 등 (330-370번대)
  * **PL 계정 (거래 중심)**: 월별 거래 발생액 합산
    - 수익계정: 매출, 이자수익, 잡이익 등 (400-420, 900-920번대)
    - 비용계정: 급여, 연구개발비, 관리비 등 (450-460, 520-530, 800-840, 930-960번대)

- **원장 데이터 추출 표준 로직**:
  * **전기이월**: 각 시트 5행 G열에서 추출
  * **월별 구분**: A열 날짜 "MM-DD" 패턴으로 월 자동 인식
  * **BS계정 처리**: 각 월 마지막 거래 후 G열 잔액 저장
  * **PL계정 처리**: 각 월별 (E열 차변 - F열 대변) 순증감 합산
  * **시트명 파싱**: 정규표현식 `\((\d+)\)`으로 계정코드 추출

- **중간 결과 파일 구조 표준**:
  * **월별잔액** 시트: BS계정 × (전기이월+12개월) 매트릭스
  * **월별발생액** 시트: PL계정 × 12개월 매트릭스
  * **계정분류** 시트: 전체 계정의 BS/PL 분류 참조 정보

- **검증 및 품질 보증**:
  * 최소 3개 대표 계정으로 이전 결과와 100% 일치 검증
  * 원장 시트 전체 스캔 후 유효 계정 수 확인 (분석 시트 제외)
  * 날짜 패턴 오류, 계정코드 추출 실패, 데이터 누락 여부 점검
  * Python 스크립트 실행 후 반드시 결과 파일 샘플 확인

### 14. 데이터 처리 시 문제 상황 대응 규칙

#### **노란색 마킹 시스템**
- **대상**: 데이터 누락, 형식 오류, 분류 실패, 검증 불가능한 모든 상황
- **방법**: openpyxl을 사용하여 해당 셀을 노란색(#FFFF00)으로 마킹
- **값 처리**: 문제 있는 셀에는 값을 입력하지 않거나 원본 그대로 유지
- **코드 예시**:
  ```python
  from openpyxl.styles import PatternFill
  yellow_fill = PatternFill(start_color="FFFF00", end_color="FFFF00", fill_type="solid")
  cell.fill = yellow_fill
  cell.value = None  # 추정값 입력 금지
  ```

#### **문제 상황별 대응 방법**
- **전기이월 판단 불가**: B5가 "전기이월"이 아니면 → 전기이월 셀 노란색 마킹
- **계정 분류 실패**: Unknown 계정코드 → 해당 행 전체 노란색 마킹
- **필수 데이터 누락**: 필요 컬럼/값 없음 → 관련 셀 노란색 마킹
- **형식 오류**: 숫자가 아닌 값 등 → 해당 셀 노란색 마킹 후 원본 유지

#### **투명한 문제 보고**
- 스크립트 완료시 노란색 셀 개수와 위치 명시적 보고
- "데이터 완결성 우선으로 X개 셀을 확인 필요로 표시했습니다"
- 로그 파일 경로와 주요 이슈 요약 제공

### 15. 로깅 시스템 및 투명성 보장

#### **필수 로그 파일 생성**
- **경로**: ./log/YYYY-MM-DD_HHMMSS.log
- **생성 시점**: 모든 데이터 처리 스크립트 실행시 의무적 생성
- **내용**: 모든 판단 근거와 문제 상황을 추적 가능하게 기록

#### **표준 로그 형식**
```
[TIMESTAMP] [LEVEL] [ACCOUNT] [ISSUE] [DETAIL] [ACTION]

예시:
[2025-08-19 14:30:15] [WARNING] [10500_정기예적금] [전기이월없음] [B5=거래내역,전기이월텍스트없음] [B2셀_노란색마킹,값비움]
[2025-08-19 14:30:22] [ERROR] [25700_미분류계정] [계정분류불가] [Unknown계정코드] [전체행_노란색마킹]
[2025-08-19 14:30:45] [INFO] [10300_보통예금] [검증성공] [전기이월일치_371,554,641원] [정상처리]
```

#### **로그 레벨 정의**
- **ERROR**: 처리 불가능, 건너뜀, 노란색 마킹
- **WARNING**: 확인 필요, 노란색 마킹, 값 비움
- **INFO**: 정상 처리되었지만 특이사항 기록
- **DEBUG**: 상세 처리 과정 추적

#### **로깅 코드 표준 (UTF-8 인코딩 필수)**
```python
import logging
from datetime import datetime
import os

# UTF-8 인코딩을 보장하는 로그 설정
log_filename = f"./log/{datetime.now().strftime('%Y-%m-%d_%H%M%S')}.log"
os.makedirs("./log", exist_ok=True)

# UTF-8 인코딩으로 로그 파일 생성
logging.basicConfig(
    filename=log_filename,
    level=logging.INFO,
    format='[%(asctime)s] [%(levelname)s] %(message)s',
    filemode='w',
    encoding='utf-8'  # UTF-8 인코딩 명시적 지정
)

# 데이터 이슈 로깅 + 노란색 마킹 동시 처리
def log_and_mark_issue(cell, account_code, sheet_name, issue, detail, workbook):
    # 한국어 텍스트 로깅 (UTF-8 보장)
    logging.warning(f"[{account_code}_{sheet_name}] [{issue}] [{detail}] [셀_노란색마킹,값비움]")
    yellow_fill = PatternFill(start_color="FFFF00", end_color="FFFF00", fill_type="solid")
    cell.fill = yellow_fill
    cell.value = None

# 텍스트 파일 생성시 UTF-8 인코딩 보장
def create_report_file(filename, content):
    with open(filename, 'w', encoding='utf-8') as f:
        f.write(content)
```

#### **로그 검토 의무**
- WARNING 이상 레벨 발생시 사용자 확인 후 진행
- 노란색 마킹된 셀 개수와 로그 엔트리 개수 1:1 대응 검증
- 모든 스크립트 완료 메시지에 로그 파일 경로 포함

### 16. 데이터 완결성 검증 체계

#### **3단계 검증 프로세스**
1. **처리 전 검증**: 원본 데이터 구조와 필수 필드 존재 여부 확인
2. **처리 중 검증**: 각 단계별 이상 데이터 즉시 감지 및 표시
3. **처리 후 검증**: 결과 데이터와 노란색 마킹 일관성 확인

#### **품질 보증 체크리스트**
- [ ] 추정값이나 기본값을 입력하지 않았는가?
- [ ] 모든 이상 상황이 노란색으로 마킹되었는가?
- [ ] 로그 파일에 모든 판단 근거가 기록되었는가?
- [ ] 노란색 셀 개수와 로그 WARNING/ERROR 개수가 일치하는가?
- [ ] 사용자가 로그를 보고 모든 상황을 이해할 수 있는가?

#### **데이터 무결성 보장**
- **원칙**: 100% 확실한 데이터만 입력
- **의심 시 행동**: 빈 값 + 노란색 마킹 + 로깅
- **검증 방법**: 원본 소스와 1:1 대조 확인
- **품질 기준**: 잘못된 데이터 0개 (빈 데이터는 허용)

### 17. 데이터 교차 오염 방지 시스템 (2025.08.19 추가)

#### **교차 오염 정의 및 위험성**
- **교차 오염**: 한 계정의 데이터가 다른 계정에 잘못 반영되는 현상
- **위험성**: 재무제표 정확성 치명적 손상, 의사결정 오류 유발
- **실제 사례**: 2023년 임대료수입 데이터가 제품매출 계정에 오염 (375건 불일치 발생)

#### **필수 교차 오염 방지 규칙**
1. **계정별 데이터 격리**
   - 각 계정 데이터 처리 시 독립성 완전 보장
   - 정규표현식 계정코드 추출 후 즉시 검증
   - 계정별 처리 완료 전 중간 결과 확인

2. **실시간 이상 패턴 감지**
   - 수익 계정에 음수값 발생시 즉시 중단 및 조사
   - 동일 금액이 여러 계정에 반복 나타나는 경우 경고
   - 원장 데이터 없는 계정에 v3 데이터 존재시 오염 의심

3. **처리 전후 교차 검증**
   - 처리 전: 원장 계정별 데이터 합계 계산
   - 처리 중: 계정별 데이터 독립성 실시간 확인
   - 처리 후: 원장 vs v3 데이터 1:1 완전 대조

#### **교차 오염 발견 시 대응 절차**
1. **즉시 작업 중단**: 오염 감지 즉시 모든 처리 중단
2. **백업 파일로 복원**: 오염 전 상태로 완전 복원
3. **근본 원인 분석**: 스크립트 로직 오류 정확한 진단
4. **수정 후 재검증**: 수정 완료 후 전체 재검증 필수

#### **교차 오염 방지 코드 표준**
```python
# 계정별 데이터 격리 보장
def extract_account_data_safely(sheet_name, account_code):
    # 1. 계정코드 추출 및 검증
    extracted_code = extract_account_code(sheet_name)
    if extracted_code != account_code:
        logging.error(f"[교차오염위험] [예상_{account_code}] [실제_{extracted_code}] [처리중단]")
        return None
    
    # 2. 격리된 데이터 처리
    isolated_data = process_data_independently(sheet_name)
    
    # 3. 처리 후 검증
    if not verify_data_integrity(isolated_data, account_code):
        logging.error(f"[데이터무결성실패] [계정_{account_code}] [재처리필요]")
        return None
    
    return isolated_data

# 교차 오염 감지 시스템
def detect_cross_contamination(v3_data, ledger_data):
    contamination_alerts = []
    
    for account_code in v3_data.keys():
        for year, year_data in v3_data[account_code].items():
            for month, v3_value in year_data.items():
                ledger_value = ledger_data.get(year, {}).get(account_code, {}).get(month, 0)
                
                # 오염 패턴 감지
                if v3_value != 0 and ledger_value == 0:
                    contamination_alerts.append({
                        'account': account_code,
                        'year': year,
                        'month': month,
                        'suspicion': 'v3에_외부데이터_유입_의심'
                    })
                    
                # 부호 반전 오류 감지
                elif v3_value * ledger_value < 0 and abs(v3_value) == abs(ledger_value):
                    contamination_alerts.append({
                        'account': account_code,
                        'year': year,
                        'month': month,
                        'suspicion': '부호반전_처리오류'
                    })
    
    return contamination_alerts
```

#### **정기적 무결성 감사 규칙**
- **주기**: 모든 재무 데이터 처리 완료 후 필수 실행
- **범위**: 4개년 전체 PL/BS 계정 교차 검증
- **기준**: 원장 vs 처리된 데이터 100% 일치
- **결과**: 불일치 0건 달성시에만 작업 완료 인정

#### **향후 확장 계획**
- 자동화된 교차 오염 감지 시스템 도입
- 실시간 데이터 무결성 모니터링
- 머신러닝 기반 이상 패턴 사전 감지

---
*이 매뉴얼은 모든 재무 프로젝트에 공통 적용됩니다.*

**2025년 8월 19일 주요 업데이트:**
- 데이터 완결성 최우선 원칙 추가
- 데이터 교차 오염 방지 시스템 구축 (임대료수입 사례 반영)
- 무결성 감사 자동화 표준 프로세스 도입